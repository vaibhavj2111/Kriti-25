import{detect as Xn}from"detect-browser";import{toMiliseconds as X,FIVE_MINUTES as Ie,fromMiliseconds as et}from"@walletconnect/time";import{getDocument as ee,getNavigator as $e,getLocation as Te}from"@walletconnect/window-getters";import{getWindowMetadata as nt}from"@walletconnect/window-metadata";import{hashMessage as Pe}from"@ethersproject/hash";import{recoverAddress as tt}from"@ethersproject/transactions";import{ChaCha20Poly1305 as je}from"@stablelib/chacha20poly1305";import{HKDF as rt}from"@stablelib/hkdf";import{randomBytes as q}from"@stablelib/random";import{SHA256 as Ae,hash as Ce}from"@stablelib/sha256";import*as Ue from"@stablelib/x25519";import{toString as v,fromString as w,concat as ne}from"uint8arrays";import{ec as ot}from"elliptic";import{decodeJWT as st}from"@walletconnect/relay-auth";import{RELAY_JSONRPC as it}from"@walletconnect/relay-api";const B=":";function te(e){const[n,t]=e.split(B);return{namespace:n,reference:t}}function _e(e){const{namespace:n,reference:t}=e;return[n,t].join(B)}function re(e){const[n,t,r]=e.split(B);return{namespace:n,reference:t,address:r}}function ke(e){const{namespace:n,reference:t,address:r}=e;return[n,t,r].join(B)}function oe(e,n){const t=[];return e.forEach(r=>{const o=n(r);t.includes(o)||t.push(o)}),t}function De(e){const{address:n}=re(e);return n}function xe(e){const{namespace:n,reference:t}=re(e);return _e({namespace:n,reference:t})}function ct(e,n){const{namespace:t,reference:r}=te(n);return ke({namespace:t,reference:r,address:e})}function at(e){return oe(e,De)}function Ve(e){return oe(e,xe)}function ut(e,n=[]){const t=[];return Object.keys(e).forEach(r=>{if(n.length&&!n.includes(r))return;const o=e[r];t.push(...o.accounts)}),t}function lt(e,n=[]){const t=[];return Object.keys(e).forEach(r=>{if(n.length&&!n.includes(r))return;const o=e[r];t.push(...Ve(o.accounts))}),t}function dt(e,n=[]){const t=[];return Object.keys(e).forEach(r=>{if(n.length&&!n.includes(r))return;const o=e[r];t.push(...H(r,o))}),t}function H(e,n){return e.includes(":")?[e]:n.chains||[]}const Me="ReactNative",y={reactNative:"react-native",node:"node",browser:"browser",unknown:"unknown"},W=" ",ft=":",Le="/",se=2,pt=1e3,Ke="js";function ie(){return typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"}function R(){return!ee()&&!!$e()&&navigator.product===Me}function mt(){return R()&&typeof global<"u"&&typeof(global==null?void 0:global.Platform)<"u"&&(global==null?void 0:global.Platform.OS)==="android"}function ht(){return R()&&typeof global<"u"&&typeof(global==null?void 0:global.Platform)<"u"&&(global==null?void 0:global.Platform.OS)==="ios"}function V(){return!ie()&&!!$e()&&!!ee()}function A(){return R()?y.reactNative:ie()?y.node:V()?y.browser:y.unknown}function yt(){var e;try{return R()&&typeof global<"u"&&typeof(global==null?void 0:global.Application)<"u"?(e=global.Application)==null?void 0:e.applicationId:void 0}catch{return}}function Fe(e,n){const t=new URLSearchParams(e);for(const r of Object.keys(n).sort())if(n.hasOwnProperty(r)){const o=n[r];o!==void 0&&t.set(r,o)}return t.toString()}function gt(){return nt()||{name:"",description:"",url:"",icons:[""]}}function vt(e,n){var t;const r=A(),o={protocol:e,version:n,env:r};return r==="browser"&&(o.host=((t=Te())==null?void 0:t.host)||"unknown"),o}function qe(){if(A()===y.reactNative&&typeof global<"u"&&typeof(global==null?void 0:global.Platform)<"u"){const{OS:t,Version:r}=global.Platform;return[t,r].join("-")}const e=Xn();if(e===null)return"unknown";const n=e.os?e.os.replace(" ","").toLowerCase():"unknown";return e.type==="browser"?[n,e.name,e.version].join("-"):[n,e.version].join("-")}function Be(){var e;const n=A();return n===y.browser?[n,((e=Te())==null?void 0:e.host)||"unknown"].join(":"):n}function He(e,n,t){const r=qe(),o=Be();return[[e,n].join("-"),[Ke,t].join("-"),r,o].join("/")}function bt({protocol:e,version:n,relayUrl:t,sdkVersion:r,auth:o,projectId:s,useOnCloseEvent:c,bundleId:a,packageName:d}){const i=t.split("?"),l=He(e,n,r),u={auth:o,ua:l,projectId:s,useOnCloseEvent:c||void 0,packageName:d||void 0,bundleId:a||void 0},f=Fe(i[1]||"",u);return i[0]+"?"+f}function Et(e){let n=(e.match(/^[^:]+(?=:\/\/)/gi)||[])[0];const t=typeof n<"u"?e.split("://")[1]:e;return n=n==="wss"?"https":"http",[n,t].join("://")}function wt(e,n,t){if(!e[n]||typeof e[n]!==t)throw new Error(`Missing or invalid "${n}" param`)}function We(e,n=se){return Je(e.split(Le),n)}function Nt(e){return We(e).join(W)}function I(e,n){return e.filter(t=>n.includes(t)).length===e.length}function Je(e,n=se){return e.slice(Math.max(e.length-n,0))}function Ot(e){return Object.fromEntries(e.entries())}function St(e){return new Map(Object.entries(e))}function Rt(e,n){const t={};return Object.keys(e).forEach(r=>{t[r]=n(e[r])}),t}const It=e=>e;function ze(e){return e.trim().replace(/^\w/,n=>n.toUpperCase())}function $t(e){return e.split(W).map(n=>ze(n)).join(W)}function Tt(e=Ie,n){const t=X(e||Ie);let r,o,s,c;return{resolve:a=>{s&&r&&(clearTimeout(s),r(a),c=Promise.resolve(a))},reject:a=>{s&&o&&(clearTimeout(s),o(a))},done:()=>new Promise((a,d)=>{if(c)return a(c);s=setTimeout(()=>{const i=new Error(n);c=Promise.reject(i),d(i)},t),r=a,o=d})}}function Pt(e,n,t){return new Promise(async(r,o)=>{const s=setTimeout(()=>o(new Error(t)),n);try{const c=await e;r(c)}catch(c){o(c)}clearTimeout(s)})}function ce(e,n){if(typeof n=="string"&&n.startsWith(`${e}:`))return n;if(e.toLowerCase()==="topic"){if(typeof n!="string")throw new Error('Value must be "string" for expirer target type: topic');return`topic:${n}`}else if(e.toLowerCase()==="id"){if(typeof n!="number")throw new Error('Value must be "number" for expirer target type: id');return`id:${n}`}throw new Error(`Unknown expirer target type: ${e}`)}function jt(e){return ce("topic",e)}function At(e){return ce("id",e)}function Ct(e){const[n,t]=e.split(":"),r={id:void 0,topic:void 0};if(n==="topic"&&typeof t=="string")r.topic=t;else if(n==="id"&&Number.isInteger(Number(t)))r.id=Number(t);else throw new Error(`Invalid target, expected id:number or topic:string, got ${n}:${t}`);return r}function Ut(e,n){return et((n||Date.now())+X(e))}function _t(e){return Date.now()>=X(e)}function kt(e,n){return`${e}${n?`:${n}`:""}`}function O(e=[],n=[]){return[...new Set([...e,...n])]}async function Dt({id:e,topic:n,wcDeepLink:t}){var r;try{if(!t)return;const o=typeof t=="string"?JSON.parse(t):t,s=o?.href;if(typeof s!="string")return;const c=Ge(s,e,n),a=A();if(a===y.browser){if(!((r=ee())!=null&&r.hasFocus())){console.warn("Document does not have focus, skipping deeplink.");return}Ye(c)}else a===y.reactNative&&typeof(global==null?void 0:global.Linking)<"u"&&await global.Linking.openURL(c)}catch(o){console.error(o)}}function Ge(e,n,t){const r=`requestId=${n}&sessionTopic=${t}`;e.endsWith("/")&&(e=e.slice(0,-1));let o=`${e}`;if(e.startsWith("https://t.me")){const s=e.includes("?")?"&startapp=":"?startapp=";o=`${o}${s}${Xe(r,!0)}`}else o=`${o}/wc?${r}`;return o}function Ye(e){let n="_self";Ze()?n="_top":(Qe()||e.startsWith("https://")||e.startsWith("http://"))&&(n="_blank"),window.open(e,n,"noreferrer noopener")}async function xt(e,n){let t="";try{if(V()&&(t=localStorage.getItem(n),t))return t;t=await e.getItem(n)}catch(r){console.error(r)}return t}function ae(e,n){return e.filter(t=>n.includes(t))}function Vt(e,n){if(!e.includes(n))return null;const t=e.split(/([&,?,=])/),r=t.indexOf(n);return t[r+2]}function Mt(){return typeof crypto<"u"&&crypto!=null&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/gu,e=>{const n=Math.random()*16|0;return(e==="x"?n:n&3|8).toString(16)})}function Lt(){return typeof process<"u"&&process.env.IS_VITEST==="true"}function Qe(){return typeof window<"u"&&(!!window.TelegramWebviewProxy||!!window.Telegram||!!window.TelegramWebviewProxyProto)}function Ze(){try{return window.self!==window.top}catch{return!1}}function Xe(e,n=!1){const t=Buffer.from(e).toString("base64");return n?t.replace(/[=]/g,""):t}function ue(e){return Buffer.from(e,"base64").toString("utf-8")}function Kt(e){return new Promise(n=>setTimeout(n,e))}const Ft="https://rpc.walletconnect.org/v1";async function en(e,n,t,r,o,s){switch(t.t){case"eip191":return nn(e,n,t.s);case"eip1271":return await tn(e,n,t.s,r,o,s);default:throw new Error(`verifySignature failed: Attempted to verify CacaoSignature with unknown type: ${t.t}`)}}function nn(e,n,t){return tt(Pe(n),t).toLowerCase()===e.toLowerCase()}async function tn(e,n,t,r,o,s){const c=te(r);if(!c.namespace||!c.reference)throw new Error(`isValidEip1271Signature failed: chainId must be in CAIP-2 format, received: ${r}`);try{const a="0x1626ba7e",d="0000000000000000000000000000000000000000000000000000000000000040",i="0000000000000000000000000000000000000000000000000000000000000041",l=t.substring(2),u=Pe(n).substring(2),f=a+u+d+i+l,h=await fetch(`${s||Ft}/?chainId=${r}&projectId=${o}`,{method:"POST",body:JSON.stringify({id:qt(),jsonrpc:"2.0",method:"eth_call",params:[{to:e,data:f},"latest"]})}),{result:p}=await h.json();return p?p.slice(0,a.length).toLowerCase()===a.toLowerCase():!1}catch(a){return console.error("isValidEip1271Signature: ",a),!1}}function qt(){return Date.now()+Math.floor(Math.random()*1e3)}var Bt=Object.defineProperty,Ht=Object.defineProperties,Wt=Object.getOwnPropertyDescriptors,rn=Object.getOwnPropertySymbols,Jt=Object.prototype.hasOwnProperty,zt=Object.prototype.propertyIsEnumerable,on=(e,n,t)=>n in e?Bt(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t,le=(e,n)=>{for(var t in n||(n={}))Jt.call(n,t)&&on(e,t,n[t]);if(rn)for(var t of rn(n))zt.call(n,t)&&on(e,t,n[t]);return e},sn=(e,n)=>Ht(e,Wt(n));const Gt="did:pkh:",J=e=>e?.split(":"),cn=e=>{const n=e&&J(e);if(n)return e.includes(Gt)?n[3]:n[1]},an=e=>{const n=e&&J(e);if(n)return n[2]+":"+n[3]},de=e=>{const n=e&&J(e);if(n)return n.pop()};async function Yt(e){const{cacao:n,projectId:t}=e,{s:r,p:o}=n,s=un(o,o.iss),c=de(o.iss);return await en(c,s,r,an(o.iss),t)}const un=(e,n)=>{const t=`${e.domain} wants you to sign in with your Ethereum account:`,r=de(n);if(!e.aud&&!e.uri)throw new Error("Either `aud` or `uri` is required to construct the message");let o=e.statement||void 0;const s=`URI: ${e.aud||e.uri}`,c=`Version: ${e.version}`,a=`Chain ID: ${cn(n)}`,d=`Nonce: ${e.nonce}`,i=`Issued At: ${e.iat}`,l=e.exp?`Expiration Time: ${e.exp}`:void 0,u=e.nbf?`Not Before: ${e.nbf}`:void 0,f=e.requestId?`Request ID: ${e.requestId}`:void 0,h=e.resources?`Resources:${e.resources.map(m=>`
- ${m}`).join("")}`:void 0,p=G(e.resources);if(p){const m=$(p);o=me(o,m)}return[t,r,"",o,"",s,c,a,d,i,l,u,f,h].filter(m=>m!=null).join(`
`)};function Qt(e,n,t){return t.includes("did:pkh:")||(t=`did:pkh:${t}`),{h:{t:"caip122"},p:{iss:t,domain:e.domain,aud:e.aud,version:e.version,nonce:e.nonce,iat:e.iat,statement:e.statement,requestId:e.requestId,resources:e.resources,nbf:e.nbf,exp:e.exp},s:n}}function Zt(e){var n;const{authPayload:t,chains:r,methods:o}=e,s=t.statement||"";if(!(r!=null&&r.length))return t;const c=t.chains,a=ae(c,r);if(!(a!=null&&a.length))throw new Error("No supported chains");const d=ln(t.resources);if(!d)return t;N(d);const i=dn(d,"eip155");let l=t?.resources||[];if(i!=null&&i.length){const u=fn(i),f=ae(u,o);if(!(f!=null&&f.length))throw new Error(`Supported methods don't satisfy the requested: ${JSON.stringify(u)}, supported: ${JSON.stringify(o)}`);const h=fe("request",f,{chains:a}),p=yn(d,"eip155",h);l=((n=t?.resources)==null?void 0:n.slice(0,-1))||[],l.push(z(p))}return sn(le({},t),{statement:vn(s,G(l)),chains:a,resources:t!=null&&t.resources||l.length>0?l:void 0})}function ln(e){const n=G(e);if(n&&pe(n))return $(n)}function Xt(e,n){var t;return(t=e?.att)==null?void 0:t.hasOwnProperty(n)}function dn(e,n){var t,r;return(t=e?.att)!=null&&t[n]?Object.keys((r=e?.att)==null?void 0:r[n]):[]}function er(e){return e?.map(n=>Object.keys(n))||[]}function fn(e){return e?.map(n=>{var t;return(t=n.split("/"))==null?void 0:t[1]})||[]}function pn(e){return Buffer.from(JSON.stringify(e)).toString("base64")}function mn(e){return JSON.parse(Buffer.from(e,"base64").toString("utf-8"))}function N(e){if(!e)throw new Error("No recap provided, value is undefined");if(!e.att)throw new Error("No `att` property found");const n=Object.keys(e.att);if(!(n!=null&&n.length))throw new Error("No resources found in `att` property");n.forEach(t=>{const r=e.att[t];if(Array.isArray(r))throw new Error(`Resource must be an object: ${t}`);if(typeof r!="object")throw new Error(`Resource must be an object: ${t}`);if(!Object.keys(r).length)throw new Error(`Resource object is empty: ${t}`);Object.keys(r).forEach(o=>{const s=r[o];if(!Array.isArray(s))throw new Error(`Ability limits ${o} must be an array of objects, found: ${s}`);if(!s.length)throw new Error(`Value of ${o} is empty array, must be an array with objects`);s.forEach(c=>{if(typeof c!="object")throw new Error(`Ability limits (${o}) must be an array of objects, found: ${c}`)})})})}function hn(e,n,t,r={}){return t?.sort((o,s)=>o.localeCompare(s)),{att:{[e]:fe(n,t,r)}}}function yn(e,n,t){var r;return e.att[n]=le({},t),((r=Object.keys(e.att))==null?void 0:r.sort((o,s)=>o.localeCompare(s))).reduce((o,s)=>(o.att[s]=e.att[s],o),{att:{}})}function fe(e,n,t={}){n=n?.sort((o,s)=>o.localeCompare(s));const r=n.map(o=>({[`${e}/${o}`]:[t]}));return Object.assign({},...r)}function z(e){return N(e),`urn:recap:${pn(e).replace(/=/g,"")}`}function $(e){const n=mn(e.replace("urn:recap:",""));return N(n),n}function nr(e,n,t){const r=hn(e,n,t);return z(r)}function pe(e){return e&&e.includes("urn:recap:")}function tr(e,n){const t=$(e),r=$(n),o=gn(t,r);return z(o)}function gn(e,n){N(e),N(n);const t=Object.keys(e.att).concat(Object.keys(n.att)).sort((o,s)=>o.localeCompare(s)),r={att:{}};return t.forEach(o=>{var s,c;Object.keys(((s=e.att)==null?void 0:s[o])||{}).concat(Object.keys(((c=n.att)==null?void 0:c[o])||{})).sort((a,d)=>a.localeCompare(d)).forEach(a=>{var d,i;r.att[o]=sn(le({},r.att[o]),{[a]:((d=e.att[o])==null?void 0:d[a])||((i=n.att[o])==null?void 0:i[a])})})}),r}function me(e="",n){N(n);const t="I further authorize the stated URI to perform the following actions on my behalf: ";if(e.includes(t))return e;const r=[];let o=0;Object.keys(n.att).forEach(a=>{const d=Object.keys(n.att[a]).map(u=>({ability:u.split("/")[0],action:u.split("/")[1]}));d.sort((u,f)=>u.action.localeCompare(f.action));const i={};d.forEach(u=>{i[u.ability]||(i[u.ability]=[]),i[u.ability].push(u.action)});const l=Object.keys(i).map(u=>(o++,`(${o}) '${u}': '${i[u].join("', '")}' for '${a}'.`));r.push(l.join(", ").replace(".,","."))});const s=r.join(" "),c=`${t}${s}`;return`${e?e+" ":""}${c}`}function rr(e){var n;const t=$(e);N(t);const r=(n=t.att)==null?void 0:n.eip155;return r?Object.keys(r).map(o=>o.split("/")[1]):[]}function or(e){const n=$(e);N(n);const t=[];return Object.values(n.att).forEach(r=>{Object.values(r).forEach(o=>{var s;(s=o?.[0])!=null&&s.chains&&t.push(o[0].chains)})}),[...new Set(t.flat())]}function vn(e,n){if(!n)return e;const t=$(n);return N(t),me(e,t)}function G(e){if(!e)return;const n=e?.[e.length-1];return pe(n)?n:void 0}const he="base10",g="base16",ye="base64pad",sr="base64url",k="utf8",ge=0,D=1,M=2,ir=0,bn=1,L=12,ve=32;function cr(){const e=Ue.generateKeyPair();return{privateKey:v(e.secretKey,g),publicKey:v(e.publicKey,g)}}function ar(){const e=q(ve);return v(e,g)}function ur(e,n){const t=Ue.sharedKey(w(e,g),w(n,g),!0),r=new rt(Ae,t).expand(ve);return v(r,g)}function lr(e){const n=Ce(w(e,g));return v(n,g)}function dr(e){const n=Ce(w(e,k));return v(n,g)}function be(e){return w(`${e}`,he)}function C(e){return Number(v(e,he))}function fr(e){const n=be(typeof e.type<"u"?e.type:ge);if(C(n)===D&&typeof e.senderPublicKey>"u")throw new Error("Missing sender public key for type 1 envelope");const t=typeof e.senderPublicKey<"u"?w(e.senderPublicKey,g):void 0,r=typeof e.iv<"u"?w(e.iv,g):q(L),o=new je(w(e.symKey,g)).seal(r,w(e.message,k));return Ee({type:n,sealed:o,iv:r,senderPublicKey:t,encoding:e.encoding})}function pr(e,n){const t=be(M),r=q(L),o=w(e,k);return Ee({type:t,sealed:o,iv:r,encoding:n})}function mr(e){const n=new je(w(e.symKey,g)),{sealed:t,iv:r}=Y({encoded:e.encoded,encoding:e?.encoding}),o=n.open(r,t);if(o===null)throw new Error("Failed to decrypt");return v(o,k)}function hr(e,n){const{sealed:t}=Y({encoded:e,encoding:n});return v(t,k)}function Ee(e){const{encoding:n=ye}=e;if(C(e.type)===M)return v(ne([e.type,e.sealed]),n);if(C(e.type)===D){if(typeof e.senderPublicKey>"u")throw new Error("Missing sender public key for type 1 envelope");return v(ne([e.type,e.senderPublicKey,e.iv,e.sealed]),n)}return v(ne([e.type,e.iv,e.sealed]),n)}function Y(e){const{encoded:n,encoding:t=ye}=e,r=w(n,t),o=r.slice(ir,bn),s=bn;if(C(o)===D){const i=s+ve,l=i+L,u=r.slice(s,i),f=r.slice(i,l),h=r.slice(l);return{type:o,sealed:h,iv:f,senderPublicKey:u}}if(C(o)===M){const i=r.slice(s),l=q(L);return{type:o,sealed:i,iv:l}}const c=s+L,a=r.slice(s,c),d=r.slice(c);return{type:o,sealed:d,iv:a}}function yr(e,n){const t=Y({encoded:e,encoding:n?.encoding});return En({type:C(t.type),senderPublicKey:typeof t.senderPublicKey<"u"?v(t.senderPublicKey,g):void 0,receiverPublicKey:n?.receiverPublicKey})}function En(e){const n=e?.type||ge;if(n===D){if(typeof e?.senderPublicKey>"u")throw new Error("missing sender public key");if(typeof e?.receiverPublicKey>"u")throw new Error("missing receiver public key")}return{type:n,senderPublicKey:e?.senderPublicKey,receiverPublicKey:e?.receiverPublicKey}}function gr(e){return e.type===D&&typeof e.senderPublicKey=="string"&&typeof e.receiverPublicKey=="string"}function vr(e){return e.type===M}function wn(e){return new ot("p256").keyFromPublic({x:Buffer.from(e.x,"base64").toString("hex"),y:Buffer.from(e.y,"base64").toString("hex")},"hex")}function br(e){let n=e.replace(/-/g,"+").replace(/_/g,"/");const t=n.length%4;return t>0&&(n+="=".repeat(4-t)),n}function Er(e){return Buffer.from(br(e),"base64")}function wr(e,n){const[t,r,o]=e.split("."),s=Er(o);if(s.length!==64)throw new Error("Invalid signature length");const c=s.slice(0,32).toString("hex"),a=s.slice(32,64).toString("hex"),d=`${t}.${r}`,i=new Ae().update(Buffer.from(d)).digest(),l=wn(n),u=Buffer.from(i).toString("hex");if(!l.verify(u,{r:c,s:a}))throw new Error("Invalid signature");return st(e).payload}const Nn="irn";function Nr(e){return e?.relay||{protocol:Nn}}function Or(e){const n=it[e];if(typeof n>"u")throw new Error(`Relay Protocol not supported: ${e}`);return n}function On(e,n="-"){const t={},r="relay"+n;return Object.keys(e).forEach(o=>{if(o.startsWith(r)){const s=o.replace(r,""),c=e[o];t[s]=c}}),t}function Sr(e){if(!e.includes("wc:")){const i=ue(e);i!=null&&i.includes("wc:")&&(e=i)}e=e.includes("wc://")?e.replace("wc://",""):e,e=e.includes("wc:")?e.replace("wc:",""):e;const n=e.indexOf(":"),t=e.indexOf("?")!==-1?e.indexOf("?"):void 0,r=e.substring(0,n),o=e.substring(n+1,t).split("@"),s=typeof t<"u"?e.substring(t):"",c=new URLSearchParams(s),a={};c.forEach((i,l)=>{a[l]=i});const d=typeof a.methods=="string"?a.methods.split(","):void 0;return{protocol:r,topic:Sn(o[0]),version:parseInt(o[1],10),symKey:a.symKey,relay:On(a),methods:d,expiryTimestamp:a.expiryTimestamp?parseInt(a.expiryTimestamp,10):void 0}}function Sn(e){return e.startsWith("//")?e.substring(2):e}function Rn(e,n="-"){const t="relay",r={};return Object.keys(e).forEach(o=>{const s=t+n+o;e[o]&&(r[s]=e[o])}),r}function Rr(e){const n=new URLSearchParams,t=Rn(e.relay);Object.keys(t).sort().forEach(o=>{n.set(o,t[o])}),n.set("symKey",e.symKey),e.expiryTimestamp&&n.set("expiryTimestamp",e.expiryTimestamp.toString()),e.methods&&n.set("methods",e.methods.join(","));const r=n.toString();return`${e.protocol}:${e.topic}@${e.version}?${r}`}function Ir(e,n,t){return`${e}?wc_ev=${t}&topic=${n}`}var $r=Object.defineProperty,Tr=Object.defineProperties,Pr=Object.getOwnPropertyDescriptors,In=Object.getOwnPropertySymbols,jr=Object.prototype.hasOwnProperty,Ar=Object.prototype.propertyIsEnumerable,$n=(e,n,t)=>n in e?$r(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t,Cr=(e,n)=>{for(var t in n||(n={}))jr.call(n,t)&&$n(e,t,n[t]);if(In)for(var t of In(n))Ar.call(n,t)&&$n(e,t,n[t]);return e},Ur=(e,n)=>Tr(e,Pr(n));function U(e){const n=[];return e.forEach(t=>{const[r,o]=t.split(":");n.push(`${r}:${o}`)}),n}function Tn(e){const n=[];return Object.values(e).forEach(t=>{n.push(...U(t.accounts))}),n}function Pn(e,n){const t=[];return Object.values(e).forEach(r=>{U(r.accounts).includes(n)&&t.push(...r.methods)}),t}function jn(e,n){const t=[];return Object.values(e).forEach(r=>{U(r.accounts).includes(n)&&t.push(...r.events)}),t}function _r(e,n){const t=Kn(e,n);if(t)throw new Error(t.message);const r={};for(const[o,s]of Object.entries(e))r[o]={methods:s.methods,events:s.events,chains:s.accounts.map(c=>`${c.split(":")[0]}:${c.split(":")[1]}`)};return r}function kr(e){const{proposal:{requiredNamespaces:n,optionalNamespaces:t={}},supportedNamespaces:r}=e,o=Ne(n),s=Ne(t),c={};Object.keys(r).forEach(i=>{const l=r[i].chains,u=r[i].methods,f=r[i].events,h=r[i].accounts;l.forEach(p=>{if(!h.some(m=>m.includes(p)))throw new Error(`No accounts provided for chain ${p} in namespace ${i}`)}),c[i]={chains:l,methods:u,events:f,accounts:h}});const a=qn(n,c,"approve()");if(a)throw new Error(a.message);const d={};return!Object.keys(n).length&&!Object.keys(t).length?c:(Object.keys(o).forEach(i=>{const l=r[i].chains.filter(p=>{var m,E;return(E=(m=o[i])==null?void 0:m.chains)==null?void 0:E.includes(p)}),u=r[i].methods.filter(p=>{var m,E;return(E=(m=o[i])==null?void 0:m.methods)==null?void 0:E.includes(p)}),f=r[i].events.filter(p=>{var m,E;return(E=(m=o[i])==null?void 0:m.events)==null?void 0:E.includes(p)}),h=l.map(p=>r[i].accounts.filter(m=>m.includes(`${p}:`))).flat();d[i]={chains:l,methods:u,events:f,accounts:h}}),Object.keys(s).forEach(i=>{var l,u,f,h,p,m;if(!r[i])return;const E=(u=(l=s[i])==null?void 0:l.chains)==null?void 0:u.filter(P=>r[i].chains.includes(P)),Yn=r[i].methods.filter(P=>{var j,x;return(x=(j=s[i])==null?void 0:j.methods)==null?void 0:x.includes(P)}),Qn=r[i].events.filter(P=>{var j,x;return(x=(j=s[i])==null?void 0:j.events)==null?void 0:x.includes(P)}),Zn=E?.map(P=>r[i].accounts.filter(j=>j.includes(`${P}:`))).flat();d[i]={chains:O((f=d[i])==null?void 0:f.chains,E),methods:O((h=d[i])==null?void 0:h.methods,Yn),events:O((p=d[i])==null?void 0:p.events,Qn),accounts:O((m=d[i])==null?void 0:m.accounts,Zn)}}),d)}function we(e){return e.includes(":")}function An(e){return we(e)?e.split(":")[0]:e}function Ne(e){var n,t,r;const o={};if(!Q(e))return o;for(const[s,c]of Object.entries(e)){const a=we(s)?[s]:c.chains,d=c.methods||[],i=c.events||[],l=An(s);o[l]=Ur(Cr({},o[l]),{chains:O(a,(n=o[l])==null?void 0:n.chains),methods:O(d,(t=o[l])==null?void 0:t.methods),events:O(i,(r=o[l])==null?void 0:r.events)})}return o}function Cn(e){const n={};return e?.forEach(t=>{const[r,o]=t.split(":");n[r]||(n[r]={accounts:[],chains:[],events:[]}),n[r].accounts.push(t),n[r].chains.push(`${r}:${o}`)}),n}function Dr(e,n){n=n.map(r=>r.replace("did:pkh:",""));const t=Cn(n);for(const[r,o]of Object.entries(t))o.methods?o.methods=O(o.methods,e):o.methods=e,o.events=["chainChanged","accountsChanged"];return t}const Un={INVALID_METHOD:{message:"Invalid method.",code:1001},INVALID_EVENT:{message:"Invalid event.",code:1002},INVALID_UPDATE_REQUEST:{message:"Invalid update request.",code:1003},INVALID_EXTEND_REQUEST:{message:"Invalid extend request.",code:1004},INVALID_SESSION_SETTLE_REQUEST:{message:"Invalid session settle request.",code:1005},UNAUTHORIZED_METHOD:{message:"Unauthorized method.",code:3001},UNAUTHORIZED_EVENT:{message:"Unauthorized event.",code:3002},UNAUTHORIZED_UPDATE_REQUEST:{message:"Unauthorized update request.",code:3003},UNAUTHORIZED_EXTEND_REQUEST:{message:"Unauthorized extend request.",code:3004},USER_REJECTED:{message:"User rejected.",code:5e3},USER_REJECTED_CHAINS:{message:"User rejected chains.",code:5001},USER_REJECTED_METHODS:{message:"User rejected methods.",code:5002},USER_REJECTED_EVENTS:{message:"User rejected events.",code:5003},UNSUPPORTED_CHAINS:{message:"Unsupported chains.",code:5100},UNSUPPORTED_METHODS:{message:"Unsupported methods.",code:5101},UNSUPPORTED_EVENTS:{message:"Unsupported events.",code:5102},UNSUPPORTED_ACCOUNTS:{message:"Unsupported accounts.",code:5103},UNSUPPORTED_NAMESPACE_KEY:{message:"Unsupported namespace key.",code:5104},USER_DISCONNECTED:{message:"User disconnected.",code:6e3},SESSION_SETTLEMENT_FAILED:{message:"Session settlement failed.",code:7e3},WC_METHOD_UNSUPPORTED:{message:"Unsupported wc_ method.",code:10001}},_n={NOT_INITIALIZED:{message:"Not initialized.",code:1},NO_MATCHING_KEY:{message:"No matching key.",code:2},RESTORE_WILL_OVERRIDE:{message:"Restore will override.",code:3},RESUBSCRIBED:{message:"Resubscribed.",code:4},MISSING_OR_INVALID:{message:"Missing or invalid.",code:5},EXPIRED:{message:"Expired.",code:6},UNKNOWN_TYPE:{message:"Unknown type.",code:7},MISMATCHED_TOPIC:{message:"Mismatched topic.",code:8},NON_CONFORMING_NAMESPACES:{message:"Non conforming namespaces.",code:9}};function S(e,n){const{message:t,code:r}=_n[e];return{message:n?`${t} ${n}`:t,code:r}}function _(e,n){const{message:t,code:r}=Un[e];return{message:n?`${t} ${n}`:t,code:r}}function K(e,n){return Array.isArray(e)?typeof n<"u"&&e.length?e.every(n):!0:!1}function Q(e){return Object.getPrototypeOf(e)===Object.prototype&&Object.keys(e).length}function T(e){return typeof e>"u"}function b(e,n){return n&&T(e)?!0:typeof e=="string"&&!!e.trim().length}function Z(e,n){return n&&T(e)?!0:typeof e=="number"&&!isNaN(e)}function xr(e,n){const{requiredNamespaces:t}=n,r=Object.keys(e.namespaces),o=Object.keys(t);let s=!0;return I(o,r)?(r.forEach(c=>{const{accounts:a,methods:d,events:i}=e.namespaces[c],l=U(a),u=t[c];(!I(H(c,u),l)||!I(u.methods,d)||!I(u.events,i))&&(s=!1)}),s):!1}function F(e){return b(e,!1)&&e.includes(":")?e.split(":").length===2:!1}function kn(e){if(b(e,!1)&&e.includes(":")){const n=e.split(":");if(n.length===3){const t=n[0]+":"+n[1];return!!n[2]&&F(t)}}return!1}function Vr(e){function n(t){try{return typeof new URL(t)<"u"}catch{return!1}}try{if(b(e,!1)){if(n(e))return!0;const t=ue(e);return n(t)}}catch{}return!1}function Mr(e){var n;return(n=e?.proposer)==null?void 0:n.publicKey}function Lr(e){return e?.topic}function Kr(e,n){let t=null;return b(e?.publicKey,!1)||(t=S("MISSING_OR_INVALID",`${n} controller public key should be a string`)),t}function Oe(e){let n=!0;return K(e)?e.length&&(n=e.every(t=>b(t,!1))):n=!1,n}function Dn(e,n,t){let r=null;return K(n)&&n.length?n.forEach(o=>{r||F(o)||(r=_("UNSUPPORTED_CHAINS",`${t}, chain ${o} should be a string and conform to "namespace:chainId" format`))}):F(e)||(r=_("UNSUPPORTED_CHAINS",`${t}, chains must be defined as "namespace:chainId" e.g. "eip155:1": {...} in the namespace key OR as an array of CAIP-2 chainIds e.g. eip155: { chains: ["eip155:1", "eip155:5"] }`)),r}function xn(e,n,t){let r=null;return Object.entries(e).forEach(([o,s])=>{if(r)return;const c=Dn(o,H(o,s),`${n} ${t}`);c&&(r=c)}),r}function Vn(e,n){let t=null;return K(e)?e.forEach(r=>{t||kn(r)||(t=_("UNSUPPORTED_ACCOUNTS",`${n}, account ${r} should be a string and conform to "namespace:chainId:address" format`))}):t=_("UNSUPPORTED_ACCOUNTS",`${n}, accounts should be an array of strings conforming to "namespace:chainId:address" format`),t}function Mn(e,n){let t=null;return Object.values(e).forEach(r=>{if(t)return;const o=Vn(r?.accounts,`${n} namespace`);o&&(t=o)}),t}function Ln(e,n){let t=null;return Oe(e?.methods)?Oe(e?.events)||(t=_("UNSUPPORTED_EVENTS",`${n}, events should be an array of strings or empty array for no events`)):t=_("UNSUPPORTED_METHODS",`${n}, methods should be an array of strings or empty array for no methods`),t}function Se(e,n){let t=null;return Object.values(e).forEach(r=>{if(t)return;const o=Ln(r,`${n}, namespace`);o&&(t=o)}),t}function Fr(e,n,t){let r=null;if(e&&Q(e)){const o=Se(e,n);o&&(r=o);const s=xn(e,n,t);s&&(r=s)}else r=S("MISSING_OR_INVALID",`${n}, ${t} should be an object with data`);return r}function Kn(e,n){let t=null;if(e&&Q(e)){const r=Se(e,n);r&&(t=r);const o=Mn(e,n);o&&(t=o)}else t=S("MISSING_OR_INVALID",`${n}, namespaces should be an object with data`);return t}function Fn(e){return b(e.protocol,!0)}function qr(e,n){let t=!1;return n&&!e?t=!0:e&&K(e)&&e.length&&e.forEach(r=>{t=Fn(r)}),t}function Br(e){return typeof e=="number"}function Hr(e){return typeof e<"u"&&typeof e!==null}function Wr(e){return!(!e||typeof e!="object"||!e.code||!Z(e.code,!1)||!e.message||!b(e.message,!1))}function Jr(e){return!(T(e)||!b(e.method,!1))}function zr(e){return!(T(e)||T(e.result)&&T(e.error)||!Z(e.id,!1)||!b(e.jsonrpc,!1))}function Gr(e){return!(T(e)||!b(e.name,!1))}function Yr(e,n){return!(!F(n)||!Tn(e).includes(n))}function Qr(e,n,t){return b(t,!1)?Pn(e,n).includes(t):!1}function Zr(e,n,t){return b(t,!1)?jn(e,n).includes(t):!1}function qn(e,n,t){let r=null;const o=Xr(e),s=eo(n),c=Object.keys(o),a=Object.keys(s),d=Bn(Object.keys(e)),i=Bn(Object.keys(n)),l=d.filter(u=>!i.includes(u));return l.length&&(r=S("NON_CONFORMING_NAMESPACES",`${t} namespaces keys don't satisfy requiredNamespaces.
      Required: ${l.toString()}
      Received: ${Object.keys(n).toString()}`)),I(c,a)||(r=S("NON_CONFORMING_NAMESPACES",`${t} namespaces chains don't satisfy required namespaces.
      Required: ${c.toString()}
      Approved: ${a.toString()}`)),Object.keys(n).forEach(u=>{if(!u.includes(":")||r)return;const f=U(n[u].accounts);f.includes(u)||(r=S("NON_CONFORMING_NAMESPACES",`${t} namespaces accounts don't satisfy namespace accounts for ${u}
        Required: ${u}
        Approved: ${f.toString()}`))}),c.forEach(u=>{r||(I(o[u].methods,s[u].methods)?I(o[u].events,s[u].events)||(r=S("NON_CONFORMING_NAMESPACES",`${t} namespaces events don't satisfy namespace events for ${u}`)):r=S("NON_CONFORMING_NAMESPACES",`${t} namespaces methods don't satisfy namespace methods for ${u}`))}),r}function Xr(e){const n={};return Object.keys(e).forEach(t=>{var r;t.includes(":")?n[t]=e[t]:(r=e[t].chains)==null||r.forEach(o=>{n[o]={methods:e[t].methods,events:e[t].events}})}),n}function Bn(e){return[...new Set(e.map(n=>n.includes(":")?n.split(":")[0]:n))]}function eo(e){const n={};return Object.keys(e).forEach(t=>{if(t.includes(":"))n[t]=e[t];else{const r=U(e[t].accounts);r?.forEach(o=>{n[o]={accounts:e[t].accounts.filter(s=>s.includes(`${o}:`)),methods:e[t].methods,events:e[t].events}})}}),n}function no(e,n){return Z(e,!1)&&e<=n.max&&e>=n.min}function to(){const e=A();return new Promise(n=>{switch(e){case y.browser:n(Hn());break;case y.reactNative:n(Wn());break;case y.node:n(Jn());break;default:n(!0)}})}function Hn(){return V()&&navigator?.onLine}async function Wn(){if(R()&&typeof global<"u"&&global!=null&&global.NetInfo){const e=await(global==null?void 0:global.NetInfo.fetch());return e?.isConnected}return!0}function Jn(){return!0}function ro(e){switch(A()){case y.browser:zn(e);break;case y.reactNative:Gn(e);break;case y.node:break}}function zn(e){!R()&&V()&&(window.addEventListener("online",()=>e(!0)),window.addEventListener("offline",()=>e(!1)))}function Gn(e){R()&&typeof global<"u"&&global!=null&&global.NetInfo&&global?.NetInfo.addEventListener(n=>e(n?.isConnected))}const Re={};class oo{static get(n){return Re[n]}static set(n,t){Re[n]=t}static delete(n){delete Re[n]}}export{he as BASE10,g as BASE16,ye as BASE64,sr as BASE64URL,ft as COLON,se as DEFAULT_DEPTH,W as EMPTY_SPACE,y as ENV_MAP,_n as INTERNAL_ERRORS,oo as MemoryStore,pt as ONE_THOUSAND,Me as REACT_NATIVE_PRODUCT,Nn as RELAYER_DEFAULT_PROTOCOL,Un as SDK_ERRORS,Ke as SDK_TYPE,Le as SLASH,ge as TYPE_0,D as TYPE_1,M as TYPE_2,k as UTF8,yn as addResourceToRecap,Fe as appendToQueryString,wt as assertType,fe as assignAbilityToActions,mn as base64Decode,pn as base64Encode,kr as buildApprovedNamespaces,Qt as buildAuthObject,Dr as buildNamespacesFromAuth,vn as buildRecapStatement,Ut as calcExpiry,$t as capitalize,ze as capitalizeWord,Tt as createDelayedPromise,nr as createEncodedRecap,Pt as createExpiringPromise,hn as createRecap,$ as decodeRecap,C as decodeTypeByte,hr as decodeTypeTwoEnvelope,mr as decrypt,ur as deriveSymKey,Y as deserialize,z as encodeRecap,be as encodeTypeByte,pr as encodeTypeTwoEnvelope,fr as encrypt,kt as engineEvent,It as enumify,ke as formatAccountId,ct as formatAccountWithChain,_e as formatChainId,Ge as formatDeeplinkUrl,ce as formatExpirerTarget,At as formatIdTarget,un as formatMessage,Nt as formatMessageContext,Rn as formatRelayParams,bt as formatRelayRpcUrl,me as formatStatementFromRecap,jt as formatTopicTarget,He as formatUA,Rr as formatUri,ue as fromBase64,cr as generateKeyPair,ar as generateRandomBytes32,U as getAccountsChains,ut as getAccountsFromNamespaces,De as getAddressFromAccount,at as getAddressesFromAccounts,yt as getAppId,gt as getAppMetadata,Hn as getBrowserOnlineStatus,xe as getChainFromAccount,Ve as getChainsFromAccounts,H as getChainsFromNamespace,lt as getChainsFromNamespaces,or as getChainsFromRecap,dt as getChainsFromRequiredNamespaces,ae as getCommonValuesInArrays,wn as getCryptoKeyFromKeyData,ln as getDecodedRecapFromResources,xt as getDeepLink,de as getDidAddress,J as getDidAddressSegments,cn as getDidChainId,A as getEnvironment,Et as getHttpUrl,S as getInternalError,Be as getJavascriptID,qe as getJavascriptOS,Je as getLastItems,Ir as getLinkModeURL,rr as getMethodsFromRecap,an as getNamespacedDidChainId,Tn as getNamespacesChains,jn as getNamespacesEventsForChainId,Cn as getNamespacesFromAccounts,Pn as getNamespacesMethodsForChainId,Jn as getNodeOnlineStatus,fn as getReCapActions,Wn as getReactNativeOnlineStatus,er as getRecapAbilitiesFromResource,G as getRecapFromResources,dn as getRecapResource,vt as getRelayClientMetadata,Or as getRelayProtocolApi,Nr as getRelayProtocolName,_r as getRequiredNamespacesFromNamespaces,_ as getSdkError,Vt as getSearchParamFromURL,oe as getUniqueValues,Dt as handleDeeplinkRedirect,I as hasOverlap,lr as hashKey,dr as hashMessage,mt as isAndroid,V as isBrowser,we as isCaipNamespace,qn as isConformingNamespaces,_t as isExpired,Ze as isIframe,ht as isIos,ie as isNode,to as isOnline,Mr as isProposalStruct,R as isReactNative,pe as isRecap,xr as isSessionCompatible,Lr as isSessionStruct,Qe as isTelegram,Lt as isTestRun,gr as isTypeOneEnvelope,vr as isTypeTwoEnvelope,T as isUndefined,kn as isValidAccountId,Vn as isValidAccounts,Ln as isValidActions,K as isValidArray,F as isValidChainId,Dn as isValidChains,Kr as isValidController,tn as isValidEip1271Signature,nn as isValidEip191Signature,Wr as isValidErrorReason,Gr as isValidEvent,Br as isValidId,Mn as isValidNamespaceAccounts,Se as isValidNamespaceActions,xn as isValidNamespaceChains,Oe as isValidNamespaceMethodsOrEvents,Kn as isValidNamespaces,Yr as isValidNamespacesChainId,Zr as isValidNamespacesEvent,Qr as isValidNamespacesRequest,Z as isValidNumber,Q as isValidObject,Hr as isValidParams,N as isValidRecap,Fn as isValidRelay,qr as isValidRelays,Jr as isValidRequest,no as isValidRequestExpiry,Fr as isValidRequiredNamespaces,zr as isValidResponse,b as isValidString,Vr as isValidUrl,Rt as mapEntries,Ot as mapToObj,O as mergeArrays,tr as mergeEncodedRecaps,gn as mergeRecaps,Ne as normalizeNamespaces,St as objToMap,Ye as openDeeplink,re as parseAccountId,te as parseChainId,We as parseContextNames,Ct as parseExpirerTarget,An as parseNamespaceKey,On as parseRelayParams,Sn as parseTopic,Sr as parseUri,Zt as populateAuthPayload,Xt as recapHasResource,Ee as serialize,Kt as sleep,zn as subscribeToBrowserNetworkChange,ro as subscribeToNetworkChange,Gn as subscribeToReactNativeNetworkChange,Xe as toBase64,Mt as uuidv4,yr as validateDecoding,En as validateEncoding,Yt as validateSignedCacao,wr as verifyP256Jwt,en as verifySignature};
//# sourceMappingURL=index.es.js.map
